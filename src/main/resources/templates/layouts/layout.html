<!DOCTYPE html>
<html class="h-100" data-bs-theme="auto"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <meta name="description" content="">
 <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
 <meta name="generator" content="Hugo 0.122.0">
 <title>Sticky Footer Navbar Template · Bootstrap v5.3</title>

 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
 
 <meta name="theme-color" content="#712cf9">
 <!-- Custom styles for this template -->
 <link href="/css/sticky-footer-navbar.css" rel="stylesheet">
 <th:block layout:fragment="script"></th:block>
 <th:block layout:fragment="css"></th:block>
</head>
<body class="d-flex flex-column h-100">
 <th:block th:replace="~{fragments/header::header}"></th:block>

 <!-- Begin page content -->
 <main class="flex-shrink-0">
   <div class="container">
     <!-- 메인('/')에서만 categorymenu 출력 -->
     <th:block th:if="${showCategoryMenu}">
         <th:block th:replace="~{fragments/categorymenu::category}"></th:block>
     </th:block>

     <!-- 페이지별 내용 -->
     <th:block layout:fragment="content"></th:block>
   </div>
 </main>
 
<!-- 챗봇 코드 추가 -->
<div id="chatbot-container"
     style="position:fixed; bottom:90px; right:30px; z-index:1000;">
  <button id="chatbot-toggle" class="btn btn-primary rounded-circle shadow"
          style="width:60px; height:60px;">
    💬
  </button>

  <div id="chatbot-window"
       style="display:none; position:absolute; bottom:70px; right:0;
              width:360px; height:480px; background:white; border-radius:12px;
              box-shadow:0 6px 20px rgba(0,0,0,0.3); overflow:hidden;">
    <div id="chatbot-messages"
         style="height:420px; overflow-y:auto; padding:10px; background:#f9fafb;">
    </div>
    <div class="input-group p-2 border-top">
      <input id="chatbot-input" type="text" class="form-control" placeholder="메시지를 입력하세요...">
      <button id="chatbot-send" class="btn btn-primary">전송</button>
    </div>
  </div>
</div>
<!-- 챗봇 코드 끝 -->

<script>
const toggleBtn = document.getElementById('chatbot-toggle');
const windowBox = document.getElementById('chatbot-window');
const sendBtn = document.getElementById('chatbot-send');
const input = document.getElementById('chatbot-input');
const messages = document.getElementById('chatbot-messages');

// 챗봇 열고 닫기
toggleBtn.addEventListener('click', () => {
  windowBox.style.display = windowBox.style.display === 'none' ? 'block' : 'none';
});

// 전송 버튼 클릭, Enter 키 이벤트
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

//메시지 전송 함수 (GET 방식으로 수정)
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage('user', text); // 사용자의 메시지 표시
  input.value = '';

  try {
    // GET 요청 + query parameter
    const url = `/admin/chatapi/chat?question=${encodeURIComponent(text)}`;
    const res = await fetch(url, {
      method: 'GET'
    });

    if (!res.ok) {
      addMessage('bot', '서버와 연결할 수 없습니다.');
      return;
    }

    // 서버가 ResponseEntity<String> 반환 → text() 사용
    const data = await res.text();
    addMessage('bot', data || '응답을 불러오지 못했습니다.');
  } catch (err) {
    console.error(err);
    addMessage('bot', '오류가 발생했습니다.');
  }
}

// 채팅창에 메시지 추가
function addMessage(sender, text) {
  const div = document.createElement('div');
  div.classList.add('my-1');
  div.innerHTML = sender === 'user'
    ? `<div class="text-end">
         <span class="badge bg-primary p-2"
               style="white-space: pre-wrap; word-break: break-word; max-width: 80%; display: inline-block;">
           ${text}
         </span>
       </div>`
    : `<div class="text-start">
         <span class="badge bg-secondary p-2"
               style="white-space: pre-wrap; word-break: break-word; max-width: 80%; display: inline-block;">
           ${text}
         </span>
       </div>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight; // 스크롤 자동 아래로
}

</script>

 <th:block th:replace="~{fragments/footer::footer}"></th:block>
 <th:block layout:fragment="script2"></th:block>
</body>
</html>
